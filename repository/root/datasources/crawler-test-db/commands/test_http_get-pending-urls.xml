<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE command SYSTEM "../../../../dtds/script-dao-commands.dtd">
<command name="test.http.get-pending-urls" type="SQL.QUERY">
         <parameters>
                     <parameter name="urlCount" />
               </parameters>
      <script>
      
select DISTINCT on (main_domain) url,id from 
(
select url,id,
case array_length(url_array,1)
when 1 then url_array[1]
when 2 then url_array[array_length(url_array,1)-1] ||'.'|| url_array[array_length(url_array,1)]
when 3 then url_array[array_length(url_array,1)-1] ||'.'|| url_array[array_length(url_array,1)]
else url_array[array_length(url_array,1)-2] ||'.'|| url_array[array_length(url_array,1)-1] ||'.'|| url_array[array_length(url_array,1)]
end main_domain
from
(
select regexp_split_to_array((split_part(substring(url,position('//' in url)+2),'/',1)), E'\\.') as url_array, url, id from pending_urls
where status='N'
and strpos(url,'http') = 1
order by random()
limit $urlCount
) ua
) mmm
   </script>
</command>